{% extends 'base.html' %}
{% load store_tags %}
{% block title %}IMSUK - {{ store.name }}{% endblock %}
{% block content %}
<style>
    .store-name { font-weight: bold; font-size: 1.8em; color: #3F8240; }
    .badge-discount { background-color: #FF69B4; color: white; font-weight: bold; padding: 5px 10px; }
    .discounted-price { font-weight: bold; font-size: 1.5em; color: #3F8240; }
    .original-price { font-size: 0.9em; color: #6c757d; text-decoration: line-through; }
    .allergen { display: inline-block; border: 1px solid #BADE80; padding: 3px 8px; margin: 3px; border-radius: 5px; background-color: #F7EFDB; font-size: 0.9em; }
    .store-image { width: 100%; max-height: 300px; object-fit: cover; }
    .additional-image { width: 100px; height: 100px; object-fit: cover; margin-right: 10px; }
    .btn-cart { background-color: #BADE80; color: #3F8240; font-weight: bold; }
    .btn-cart:hover { background-color: #A8C66B; }
    .opening-hours { font-size: 1em; color: #3F8240; }
    .clock-icon { margin-right: 5px; color: #3F8240; }
    .carousel-inner { max-height: 150px; }
    .alert-success { background-color: #BADE80; color: #3F8240; }
</style>

<div class="container mt-4">
    <div class="row">
        <!-- Images -->
        <div class="col-md-5">
            {% if store.store_image %}
            <img src="{{ store.store_image.url }}" class="store-image img-thumbnail mb-3" alt="{{ store.name }}">
            {% else %}
            <img src="https://via.placeholder.com/400x300" class="store-image img-thumbnail mb-3" alt="Store image not available">
            {% endif %}
            {% if store.additional_images and store.additional_images|length > 0 %}
            <div id="additionalImagesCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for img in store.additional_images %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img src="{{ img }}" class="additional-image d-block w-100" alt="Additional image for {{ store.name }}">
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#additionalImagesCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#additionalImagesCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
            {% endif %}
        </div>
        <!-- Store Details -->
        <div class="col-md-7">
            <h1 class="store-name">{{ store.name }}</h1>
            <p>
                {% if store.discount_percentage and store.discount_percentage > 0 %}
                <span class="badge badge-discount">-{{ store.discount_percentage|floatformat:0 }}%</span>
                <span class="discounted-price">{{ store.discounted_price|floatformat:0 }} บาท</span>
                <span class="original-price">{{ store.price|floatformat:0 }} บาท</span>
                {% else %}
                <span class="discounted-price">{{ store.price|floatformat:0 }} บาท</span>
                {% endif %}
            </p>
            <p class="opening-hours">
                <i class="fas fa-clock clock-icon"></i>
                {{ store.available_from|time:"H:i" }} - {{ store.available_until|time:"H:i" }}
            </p>
            {% if store.quantity_available %}
            <p><strong>Available Quantity:</strong> {{ store.quantity_available }}</p>
            {% endif %}
            {% if store.allergen_ingredients %}
            <p><strong>Allergens:</strong>
                {% for allergen in store.allergen_ingredients|split:"," %}
                <span class="allergen">{{ allergen }}</span>
                {% endfor %}
            </p>
            {% endif %}
            {% if store.description %}
            <p><strong>Description:</strong> {{ store.description }}</p>
            {% endif %}
            {% if store.additional_details %}
            <p><strong>Additional Details:</strong> {{ store.additional_details }}</p>
            {% endif %}
            <!-- Add to Cart Form -->
            <form method="post" class="d-flex align-items-center add-to-cart-form mt-3">
                {% csrf_token %}
                <input type="hidden" name="store_id" value="{{ store.id }}">
                <input type="number" name="quantity" value="1" min="1" max="{{ store.quantity_available }}" class="form-control quantity-input me-2" aria-label="Quantity" style="width: 100px;">
                <button type="submit" class="btn btn-cart">Add to Cart</button>
            </form>
        </div>
    </div>
</div>

<!-- Messages -->
{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<script>
    document.querySelector('.add-to-cart-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("{% url 'store_detail' store.id %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            const alertContainer = document.querySelector('.container.mt-3') || document.createElement('div');
            if (!alertContainer.classList.contains('container')) {
                alertContainer.className = 'container mt-3';
                document.querySelector('.container.mt-4').after(alertContainer);
            }
            const alert = document.createElement('div');
            alert.className = `alert alert-${data.success ? 'success' : 'danger'} alert-dismissible fade show`;
            alert.innerHTML = `${data.message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            alertContainer.prepend(alert);
            setTimeout(() => alert.classList.remove('show'), 3000);
            setTimeout(() => alert.remove(), 3500);
        });
    });
</script>
{% endblock %}